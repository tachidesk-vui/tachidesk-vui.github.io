import{Q as _}from"./QCard.2afe773c.js";import{Q as j}from"./QSpinnerDots.8a60c591.js";import{Q as D}from"./QInfiniteScroll.5798f754.js";import{Q as N}from"./QPage.c574ddc8.js";import{I as Q}from"./Intersection.1f34fdb3.js";import{d as B,r as u,_ as R,f as l,v as c,m as y,ab as g,q as I,j as P,k as v,n as $,aa as O,s as q,u as m,x as C,F as b,y as V,t as L}from"./index.c2bd2839.js";import{Q as x,g as E}from"./usefull.c307d8f6.js";import{Q as W}from"./QInnerLoading.a6c3bac7.js";import{c as F}from"./readerSettings.47c6e278.js";import"./use-dark.da6555f7.js";import"./QSpinner.b1186f68.js";import"./dom.b848fa26.js";import"./scroll.c22aa5f6.js";import"./axios.9d358765.js";import"./StoreStuff.bf379ea5.js";import"./getenv.7492fdf7.js";import"./use-transition.54d11fde.js";const z=B({name:"DisplayPage",props:{pageNum:{type:Number,required:!0},chapterID:{type:Number,required:!0},vueRM:{type:String,default:"RTL"},vueWT:{type:Boolean,default:!1},vueScale:{type:Boolean,default:!1},vueOffset:{type:Boolean,default:!1},imdata:{type:Promise,default:void 0}},setup(){return{imgdata:u("")}},computed:{isBook(){return["RTL","LTR","SinglePage"].includes(this.vueRM)},isBook2(){return["RTL","LTR"].includes(this.vueRM)},imgstyle(){return this.vueScale?this.isBook?(this.isBook2,"width: fit-content;"):"width:100%;height:fit-content;":"width: fit-content;max-width:100%"},imgClass(){return this.vueScale?this.isBook?(this.isBook2,"test"):"":"test"},imgfit(){return this.vueScale?this.isBook?(this.isBook2,"scale-down"):"fill":"scale-down"},imgimgstyle(){return this.vueScale?this.isBook?this.isBook2?{height:"100%",width:"fit-content"}:{height:"100%",width:"fit-content"}:{width:"100%",height:"fit-content"}:{width:"fit-content",maxWidth:"100%"}},imgcontstyle(){if(this.vueScale){if(this.isBook){if(this.isBook2){let t=1;return this.pageNum%2&&(t*=-1),this.vueRM=="RTL"&&(t*=-1),this.vueOffset&&(t*=-1),"width:50%;height:100vh;align-items:"+(t==-1?"start":"end")}return"max-width:100%;height:100vh"}return"width:100%;height:fit-content;"}if(this.isBook2){const t=this.pageNum%2?this.vueRM=="RTL"?"end":"start":this.vueRM=="RTL"?"start":"end";return"width:50%;align-items:"+t}return"max-width:100%"}},watch:{pageNum(){this.getImg()}},mounted:function(){this.getImg()},methods:{getImg(){var t;(t=this.imdata)==null||t.then(e=>{this.imgdata=e})}}});function A(t,e,i,s,a,h){return l(),c("div",{class:I(["column items-center justify-center",t.vueScale&&!t.isBook?"":"displayPage"]),style:g(t.imgcontstyle)},[y(x,{style:g([{"max-width":"-webkit-fill-available"},t.imgstyle]),loading:"lazy",class:I(t.vueWT?t.isBook2?"q-mx-md":"q-ma-md":""),src:t.imgdata,fit:t.imgfit,"img-class":t.imgClass,"img-style":t.imgimgstyle},null,8,["style","class","src","fit","img-class","img-style"]),t.imgdata?$("",!0):(l(),P(_,{key:0,flat:"",style:{height:"100vh","background-color":"transparent",width:"100%"}},{default:v(()=>[y(W,{showing:!t.imgdata,color:"primary",class:"bg-transparent"},null,8,["showing"])]),_:1}))],6)}var H=R(z,[["render",A]]);const p={L:{forward:[[100,100],[100,0],[66,0],[66,66],[0,66],[0,100]],back:[[33,33],[66,33],[66,0],[0,0],[0,66],[33,66]],menu:[[33,33],[66,33],[66,66],[33,66]]},RAL:{forward:[[66,0],[100,0],[100,100],[66,100]],back:[[0,0],[33,0],[33,100],[0,100]],menu:[[33,0],[66,0],[66,100],[33,100]]},Kindle:{forward:[[33,33],[33,100],[100,100],[100,33]],back:[[33,33],[33,100],[0,100],[0,33]],menu:[[0,0],[100,0],[100,33],[0,33]]},Edge:{forward:[[100,0],[100,100],[0,100],[0,0],[33,0],[33,100],[66,100],[66,0]],back:[[33,66],[66,66],[66,100],[33,100]],menu:[[33,66],[66,66],[66,0],[33,0]]}},Y=B({name:"ChapterPage",components:{displayPage:H},emits:["set-title","open-menu"],setup(){const t=u([]),e=u([]),i=O(),s=u(parseInt(`${i.params.chapterID}`)),a=u(void 0),h=u([]),o=F(parseInt(`${i.params.mangaID}`)),r=o.vue_RM,d=o.vue_Paths,f=o.pathVisable,n=o.vue_WT,k=o.vue_Scale,w=o.vue_Offset,T=o.vue_title,S=u(""),M=o.vue_Paths;return{items:e,currchapter:s,nextChapter:a,Pages:h,vue_RM:r,vue_Path:d,pathVisable:f,vue_WT:n,vue_Scale:k,vue_Offset:w,chapname:S,vue_title:T,pageIntersectEleArr:t,scrolltimeout:u(!0),usedpath:M}},computed:{isBook(){return["RTL","LTR","SinglePage"].includes(this.vue_RM)},isBook2(){return["RTL","LTR"].includes(this.vue_RM)},divClass(){return this.isBook2?"row items-center":""},clipPathF(){return`clip-path: polygon(${p[this.usedpath].forward.map(e=>e.map(i=>i==0?i.toString():`${i}%`).join(" ")).join(",")});top: 0;
      bottom: 0;
      left: 0;
      right: 0;`},clipPathB(){return`clip-path: polygon(${p[this.usedpath].back.map(e=>e.map(i=>i==0?i.toString():`${i}%`).join(" ")).join(",")});top: 0;
      bottom: 0;
      left: 0;
      right: 0;`},clipPathM(){const t=p[this.usedpath].menu;return t===void 0?"":`clip-path: polygon(${t.map(e=>e.map(i=>i==0?i.toString():`${i}%`).join(" ")).join(",")});top: 0;
      bottom: 0;
      left: 0;
      right: 0;`}},watch:{vue_title(){this.$emit("set-title",`${this.chapname} ${this.vue_title}`)}},created(){window.addEventListener("keydown",this.keyHandeler)},beforeUnmount(){window.removeEventListener("keydown",this.keyHandeler)},methods:{async getImg(t,e){return E(`/api/v1/manga/${this.$route.params.mangaID}/chapter/${t}/page/${e}?useCache=${this.$storeGet("useCache",!0)}`)},myTweak(t){return{height:t?`calc(100vh - ${t}px)`:"100vh"}},onChapter(t,e){var i;this.items.push(t),this.currchapter!=parseInt(`${this.$route.params.chapterID}`)&&((i=this.$route.name)==null?void 0:i.toString())=="chapterpage"&&this.$router.replace(`/manga/${this.$route.params.mangaID}/chapter/${this.currchapter}`),e(),this.chapname=t.name,this.$emit("set-title",`${this.vue_title} ${t.name}`),this.currchapter>=t.chapterCount?this.$refs.infiniteScrol.stop():(this.currchapter++,this.getNextChap())},onLoad(t,e){this.nextChapter===void 0?this.$api.get(`/api/v1/manga/${this.$route.params.mangaID}/chapter/${this.currchapter}`).then(({data:i})=>{var s;this.Pages[this.currchapter]=[];for(let a=0;a<i.pageCount;a++)(s=this.Pages[this.currchapter])==null||s.push(this.getImg(i.index,a));this.onChapter(i,e)}):this.nextChapter.then(i=>{this.onChapter(i,e)})},async getNextChap(){this.nextChapter=this.$api.get(`/api/v1/manga/${this.$route.params.mangaID}/chapter/${this.currchapter}`).then(({data:t})=>t),this.nextChapter.then(t=>{var e;this.Pages[this.currchapter]=[];for(let i=0;i<t.pageCount;i++)(e=this.Pages[this.currchapter])==null||e.push(this.getImg(t.index,i))})},onIntersection(t){const e=t.target;t.isIntersecting?(this.setReadPages(e),e.dataset.isint="true"):e.dataset.isint=void 0},setReadPages(t){this.$api.patchForm(`/api/v1/manga/${this.$route.params.mangaID}/chapter/${t.dataset.cid}`,{lastPageRead:`${parseInt(t.dataset.pid)+1}`}),parseInt(t.dataset.pid)>=parseInt(t.dataset.pcount)-1&&this.$api.patchForm(`/api/v1/manga/${this.$route.params.mangaID}/chapter/${t.dataset.cid}`,{read:"true"})},goNextIntersector80(){if(this.scrolltimeout){this.scrolltimeout=!1,setTimeout(()=>{this.scrolltimeout=!0},500);const t=window.visualViewport,e=t.pageTop,i=t.pageTop+t.height,s=Array.from(this.$refs.infiniteScrol.$el.querySelectorAll("[data-isint=true]"));if(s.length>0){const a=s[s.length-1];if(a.offsetTop>i||a.offsetTop<=e){a.dataset.isint=void 0,this.scrolltimeout=!0,this.goNextIntersector80();return}a&&(s.forEach(h=>{h.dataset.isint=h==a?"true":void 0}),window.scrollTo({top:a.offsetTop,left:0,behavior:"smooth"}))}else this.scroll80()}},scroll80(){const t=window.visualViewport;window.scrollTo({top:t.pageTop+t.height*.8,left:0,behavior:"smooth"})},scrollUp80(){if(this.scrolltimeout){this.scrolltimeout=!1,setTimeout(()=>{this.scrolltimeout=!0},500);const t=window.visualViewport;window.scrollTo({top:t.pageTop-t.height*.8,left:0,behavior:"smooth"})}},keyHandeler(t){t.key==" "&&(t.preventDefault(),this.goNextIntersector80())},pagee(t,e){const i=this.Pages[t];if(i!=null&&i.length){const s=i[e];if(s!=null)return s}return this.getImg(t,e)},handleClick(t){this.pointInPoly([t.x,t.y],this.polyToPOLLY(p[this.usedpath].forward))?this.goNextIntersector80():this.pointInPoly([t.x,t.y],this.polyToPOLLY(p[this.usedpath].back))?this.scrollUp80():p[this.usedpath].menu&&this.pointInPoly([t.x,t.y],this.polyToPOLLY(p[this.usedpath].menu))&&this.$emit("open-menu")},polyToPOLLY(t){if(t!=null)return t.map(e=>[e[0]*window.innerWidth/100,e[1]*window.innerHeight/100])},pointInPoly(t,e){if(e==null)return!1;const i=t[0],s=t[1];let a=!1;for(let h=0,o=e.length-1;h<e.length;o=h++){const r=e[h],d=e[o],f=r[0],n=r[1],k=d[0],w=d[1];n>s!=w>s&&i<(k-f)*(s-n)/(w-n)+f&&(a=!a)}return a}}}),U={key:0,style:{width:"50%"}},G={class:"col"},K={class:"col"},J={class:"row justify-center q-py-md"},X={key:0};function Z(t,e,i,s,a,h){const o=q("displayPage");return l(),P(N,{"style-fn":t.myTweak,onClick:t.handleClick},{default:v(()=>[m("div",null,[y(D,{ref:"infiniteScrol",offset:t.$q.screen.height*5,onLoad:t.onLoad},{loading:v(()=>[m("div",J,[y(j,{color:"primary",size:"40px"})])]),default:v(()=>[(l(!0),c(b,null,C(t.items,(r,d)=>(l(),c("div",{key:d,class:I(t.divClass)},[t.vue_Offset&&t.isBook2?(l(),c("div",U)):$("",!0),(l(!0),c(b,null,C(r.pageCount,(f,n)=>V((l(),P(o,{key:n,"page-num":t.vue_RM=="RTL"?n%2?n-1:n+1:n,"chapter-i-d":r.index,"data-pid":n,"data-cid":r.index,"data-pcount":r.pageCount,"vue-r-m":t.vue_RM,"vue-w-t":t.vue_WT,"vue-scale":t.vue_Scale,"vue-offset":t.vue_Offset,imdata:t.pagee(r.index,n)},null,8,["page-num","chapter-i-d","data-pid","data-cid","data-pcount","vue-r-m","vue-w-t","vue-scale","vue-offset","imdata"])),[[Q,t.onIntersection]])),128)),y(_,{style:g([{height:"100vh","max-height":"500px"},t.isBook2?"width:100%":""]),class:"column text-center q-ml-md"},{default:v(()=>[m("h5",G,"End of "+L(r.name),1),m("p",K,L(r.index>=r.chapterCount?"no chapters remaining":"keep scrolling for the next chapter"),1)]),_:2},1032,["style"])],2))),128))]),_:1},8,["offset","onLoad"])]),t.pathVisable?(l(),c("div",X,[m("div",{class:"fixed",style:g([{"background-color":"rgba(0, 0, 255, 0.5)"},t.clipPathF])},null,4),m("div",{class:"fixed",style:g([{"background-color":"rgba(255, 0, 0, 0.5)"},t.clipPathB])},null,4),t.clipPathM?(l(),c("div",{key:0,class:"fixed",style:g([{"background-color":"rgba(0, 255, 0, 0.5)"},t.clipPathM])},null,4)):$("",!0)])):$("",!0)]),_:1},8,["style-fn","onClick"])}var vt=R(Y,[["render",Z]]);export{vt as default};
